from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException 
import requests
from requests import ConnectionError

op = webdriver.ChromeOptions()
op.add_argument('headless')
op.add_argument('--log-level=3')
driver = webdriver.Chrome(options=op)


def check_link(list):
    headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36'}
    
    ##TODO add function if that link contains info we need
     

    exist_links = []
    for link in list:
        try:
            if requests.get(link, headers=headers).status_code == 200:
                exist_links.append(link)
        except ConnectionError:
            pass

    return exist_links        


def nist(cve_id):
    driver.get(f'https://nvd.nist.gov/vuln/detail/{cve_id}')

    # references
    references = driver.find_elements(By.XPATH, '//*[@id="vulnHyperlinksPanel"]/table/tbody')

    # editing list 
    ref_list = [elm.text for elm in references]
    ref_list = ref_list[0].split('\n')
    links = [i.split(' ')[0] for i in ref_list]

    link = check_link(links)

    # Checks Cvss3 if not exist returns cvss2
    try:
        if bool(driver.find_element(By.ID, 'Cvss3NistCalculatorAnchor')):
            severity = driver.find_element(By.ID, 'Cvss3NistCalculatorAnchor').text
            vector = driver.find_element(By.XPATH, '//*[@id="Vuln3CvssPanel"]/div[1]/div[3]/span/span').text
    except NoSuchElementException:
        if bool(driver.find_element(By.ID, 'Cvss3NistCalculatorAnchorNA')):
            driver.find_element(By.ID, 'btn-cvss2').click()
            severity = driver.find_element(By.ID, 'Cvss2CalculatorAnchor').text
            vector = driver.find_element(By.XPATH, '//*[@id="Vuln2CvssPanel"]/div[1]/div[3]/span/span').text

    # Description handling
    try:
        description = driver.find_element(By.XPATH, '//*[@id="vulnDetailTableView"]/tbody/tr/td/div/div[1]/p').text
    except NoSuchElementException:
        print("Something went wrong with CVE ID you provided!!! Please contact with developers!")

    print(len(link))
    print(link)
    print(20*"*******")
    print(severity)
    print(20*"*******")
    print(vector)
    print(20*"*******")
    print(description)

def mitre(cve_id):
    driver.get(f'https://cve.mitre.org/cgi-bin/cvename.cgi?name={cve_id}')

    description = driver.find_element(By.XPATH, '//*[@id="GeneratedTable"]/table/tbody/tr[4]/td')

#######################################
    links = driver.find_elements(By.XPATH, '//*[@id="GeneratedTable"]/table/tbody/tr[7]/td/ul')

    list = [i.text for i in links]
    list = list[0].split('\n')

    # delete unwanted items 
    url = []
    for item in list:
        parts = item.split(':')  # Split item by ':'
        if len(parts) > 1 and parts[1].startswith('http'):  # Check if the second part starts with 'http'
            link = ':'.join(parts[1:])  # Join the remaining parts back together
            url.append(link.strip())  # Add the URL to the urls list after stripping any leading/trailing whitespace
    # url list contains actual references links
    
    url = check_link(url)

    #TODO add condition if list is empty

    
#######################################
    
    # Assingning CNA
    assigning_CNA = driver.find_element(By.XPATH, '//*[@id="GeneratedTable"]/table/tbody/tr[9]/td').text
    if assigning_CNA == '':
        assigning_CNA = 'There is no information to display'

    # record create date
    date = driver.find_element(By.XPATH, '//*[@id="GeneratedTable"]/table/tbody/tr[11]/td[1]/b').text
    if date == '':
        date = 'There is no information to display'

    # Comment
    comment = driver.find_element(By.XPATH, '//*[@id="GeneratedTable"]/table/tbody/tr[17]/td').text
    if comment == '':
        comment = 'There is no information to display'


    print(20*"*******")
    print(description.text)
    print(20*"*******")
    print(url)
    print(len(url))
    print(20*"*******")
    print(assigning_CNA)
    print(20*"*******")
    print(date)
    print(20*"*******")
    print(comment)


mitre("CVE-2020-3169")
import re
from datetime import datetime
import requests
import os
import sys
from art import *
from colorama import init, Fore, Style
from scrap import *
from reporter import * 

def usage_message():
    print('''Hmm, it seems like the CVE ID you entered is not quite right. CVE IDs typically follow a specific format to identify security vulnerabilities. Please make sure your input looks something like this: 'CVE-YYYY-NNNN' or 'YYYY-NNNN', where:
- 'CVE' stands for Common Vulnerabilities and Exposures.
- 'YYYY' represents the year the vulnerability was assigned.
- 'NNNN' is a sequence number assigned to the vulnerability for that year.

For example, a valid CVE ID could be 'CVE-2017-0144' or '2017-0144'. Take a moment to double-check your input and try again!
''')


def is_valid_cve(input_str):
    global user_input

    pattern = r'^(cve-|CVE-)?[0-9]{4}-[0-9]{4,}$'

    if re.match(pattern,input_str):
        if not input_str.startswith("CVE-"):
            user_input = input_str = "CVE-" + input_str 

    # check if year section of ID is valid
    if bool(re.match(pattern, input_str)):
        split_input = input_str.upper().split('-') or input_str.upper().split(' ')
        if 1999 <= int(split_input[1]) <= int(datetime.now().year) and int(split_input[2]) != 0:
            return bool(re.match(pattern, input_str))
        else:
            return False


def is_cve_exist(cve_id):
    api_url = f"https://cveawg.mitre.org/api/cve-id/{cve_id}"

    response = requests.get(api_url)

    # Check if the response status code is successful (200 OK)
    if response.status_code == 200:
        cve_data = response.json()

        # Check if Published
        if "PUBLISHED" in cve_data["state"]:
            print(Fore.GREEN + f"[•] CVE ID {cve_id} exists.")
            print(Style.RESET_ALL)
            return True

        # Check if Rejected
        elif "REJECTED" in cve_data["state"]:
            print(f"[•] CVE ID: {cve_id} is" + Fore.LIGHTRED_EX + " REJECTED")
            print(Style.RESET_ALL)
            sys.exit()
                

        # Check if Reserverd
        elif "RESERVED" in cve_data["state"]:
            print(f"[•] CVE ID: {cve_id} is" + Fore.LIGHTRED_EX + " RESERVED")
            print(Style.RESET_ALL)
            sys.exit()



    else:
        return False
    

def funny_mes():
    print(Style.RESET_ALL)
    os.system('cls')
    print(Fore.MAGENTA)
    tprint("I  said  give  valid  input!\n", font='small')
    tprint("Please start program again!", font='small')
    print(Style.RESET_ALL)
    sys.exit()


try:
    # Clear console
    if os.name == 'nt':
        os.system("cls")
    else:
        os.system("clear")
    

    ######  Welcoming user! --START--  ######
    tprint("Welcome  to  CVE reporter", font='small')
    ######  Welcoming user! --END--    ######
        

    # User input
    user_input = input(Fore.CYAN + "[•] Enter CVE ID: ").upper()
    print(Style.RESET_ALL)

    while not is_valid_cve(user_input):
        print(Fore.RED)
        tprint("Invalid   CVE   ID", font="small")
        print(Style.RESET_ALL)
        usage_message()
        user_input = input(Fore.CYAN + "[•] Enter CVE ID: ").upper()
        print(Style.RESET_ALL)


    # Check validation
    if is_valid_cve(user_input):

        # Actions is input valid
        print(Fore.GREEN + "[•] Valid CVE ID input")
        print(Style.RESET_ALL)
        
        if is_cve_exist(user_input):
            # Actions if cve is exist

            # Ask for resource
            user_input_source = input(Fore.WHITE + "[1] nist.com\n[2] mitre.org\n[3] vulners.com\n"+ Fore.GREEN + "\n[•] Which source would you like to get info from(please enter a number): ")
            print(Style.RESET_ALL)

            attemp = 0

            # validate input
            while user_input_source not in ["1","2","3"]:

                # Count attemps
                if attemp == 5: 
                    funny_mes()
                    break
                else:
                    print(Fore.RED+ "Please enter valid answer!")
                    print(Style.RESET_ALL)
                    user_input_source = input(Fore.WHITE + "[1] nist.com\n[2] mitre.org\n[3] vulners.com\n"+ Fore.GREEN + "\n[•] Which source would you like to get info from(please enter a number): ")
                    print(Style.RESET_ALL)
                    attemp += 1
            
            # Actions after valid source input
            
            # Ask for output
            user_input_output = input(Fore.WHITE + "[1] pdf\n[2] docx\n[3] console" + Fore.GREEN + "\n[•] How would you like your output(please enter a number): ")
            print(Style.RESET_ALL)
            attemp2 = 0
            while user_input_output not in ["1","2","3"]:

                # Count attemps
                if attemp2 == 5: 
                    funny_mes()
                    break
                else:
                    print(Fore.RED+ "Please enter valid answer!")
                    print(Style.RESET_ALL)
                    user_input_output = input(Fore.WHITE + "[1] pdf\n[2] docx\n[3] console" + Fore.GREEN + "\n[•] How would you like your output(please enter a number): ")
                    print(Style.RESET_ALL)
                    attemp2 += 1
            # Ask for exploit
            exploit_input = input(Fore.WHITE + "[•] Would you like to show exploit links(Y/n): " )
            print(Style.RESET_ALL)

            while exploit_input not in ['y', 'Y', 'n', 'N', '']:
                print(Fore.RED+ "[•] Please enter valid answer!")
                print(Style.RESET_ALL)
                exploit_input = input(Fore.WHITE + "[•] Would you like to show exploit links(Y/n): " )


            
            # If console display was selected
            if user_input_output == '3':
                if user_input_source == '1':
                    os.system('cls')
                    tprint(user_input, font='small')
                    print(Fore.GREEN + "Severity:\n" + Fore.WHITE + nist(user_input)['severity'])
                    print(Style.RESET_ALL)
                    print(Fore.GREEN + "Vector: " + Fore.WHITE + nist(user_input)['vector'])
                    print(Style.RESET_ALL)
                    print(Fore.GREEN + "Description:\n" + Fore.WHITE + nist(user_input)['description'])
                    print(Style.RESET_ALL)
                    print(Fore.GREEN + "Reference:\n")
                    print(Style.RESET_ALL)
                    for i in nist(user_input)['reference']:
                        print(i)
                    if exploit_input in ['y', 'Y', '']:
                        print(Fore.GREEN + 'Exploits:\n')
                        print(Style.RESET_ALL)
                        for link in get_exploit(user_input):
                            print(link)


                    # open links 

                    options = webdriver.ChromeOptions()
                    options.add_argument("--log-level=3")
                    driver = webdriver.Chrome(options=options)

                    
                    for link in nist(user_input)['reference'][:4]:
                        driver.execute_script("window.open('{}', '_blank')".format(link))
    
                    for handle in driver.window_handles:
                        driver.switch_to.window(handle)

                    input("\nPress something to close the browser...")
                    sys.exit()
                elif user_input_source == '2':
                    os.system('cls')
                    tprint(user_input, font='small')
                    print(Fore.GREEN + "Description:\n" + Fore.WHITE + mitre(user_input)['description'])
                    print(Style.RESET_ALL)
                    print(Fore.GREEN + "Reference:\n")
                    print(Style.RESET_ALL)
                    for i in mitre(user_input)['references']:
                        print(i)
                    if exploit_input in ['y', 'Y', '']:
                        print(Fore.GREEN + 'Exploits:\n')
                        print(Style.RESET_ALL)
                        for link in get_exploit(user_input)['exploit_link']:
                            print(link)


                    # open links 

                    options = webdriver.ChromeOptions()
                    options.add_argument("--log-level=3")
                    driver = webdriver.Chrome(options=options)

                    
                    for link in mitre(user_input)['references'][:4]:
                        driver.execute_script("window.open('{}', '_blank')".format(link))
    
                    for handle in driver.window_handles:
                        driver.switch_to.window(handle)

                    input("\nPress something to close the browser...")

                    sys.exit()
                elif user_input_source == '3':
                    os.system('cls')
                    tprint(user_input, font='small')
                    print(Fore.GREEN + "CVVS:\n" + Fore.WHITE + vulners(user_input)['cvvs'])
                    print(Style.RESET_ALL)
                    print(Fore.GREEN + "Description:\n" + Fore.WHITE + vulners(user_input)['description'])
                    print(Style.RESET_ALL)
                    print(Fore.GREEN + "Reference:\n")
                    print(Style.RESET_ALL)
                    for i in vulners(user_input)['references']:
                        print(i)
                    if exploit_input in ['y', 'Y', '']:
                        print(Fore.GREEN + 'Exploits:\n')
                        print(Style.RESET_ALL)
                        for link in get_exploit(user_input):
                            print(link)

                    # open links 

                    options = webdriver.ChromeOptions()
                    options.add_argument("--log-level=3")
                    driver = webdriver.Chrome(options=options)

                    
                    for link in vulners(user_input)['references'][:4]:
                        driver.execute_script("window.open('{}', '_blank')".format(link))
    
                    for handle in driver.window_handles:
                        driver.switch_to.window(handle)

                    input("\nPress something to close the browser...")

                    sys.exit()
            

            # Documentation creation
            if user_input_source == '1':
                create_nist_document(cve_id=user_input, nist_data=nist(user_input), output_format=user_input_output, exploit = exploit_input )
            elif user_input_source == '2':
                create_mitre_document(cve_id=user_input, mitre_data=mitre(user_input), output_format=user_input_output, exploit= exploit_input)
            elif user_input_source == '3':
                create_vulners_document(cve_id=user_input, vulners_data=vulners(user_input), output_format=user_input_output, exploit=exploit_input)
            else:
                print("something went wrong")
            
            

        else:
            # Actions if cve doesn't exist
            print(Fore.RED + f"[•] CVE ID: {user_input} doesn't exist")
            print(Style.RESET_ALL)
            sys.exit()




except KeyboardInterrupt:
    os.system("cls")
    print(Fore.RED + "\nExiting...")
    tprint("See you later!", font="small")
    print(Style.RESET_ALL)
    sys.exit()
    
except TypeError:
    os.system("cls")
    print(Fore.RED + "\nDeveloper did something wrong, please contact developers!")
    tprint("See you later!", font="small")
    print(Style.RESET_ALL)